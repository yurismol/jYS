
# This file is automatically generated, you probably don't want to edit this

mCOROptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "mCOROptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            vars = NULL,
            group = NULL,
            selgroup = NULL,
            hyp = "corr",
            method = "pearson",
            adjust = "none",
            tables = TRUE,
            pval = TRUE,
            flag = FALSE,
            n = FALSE,
            ci = FALSE,
            ciWidth = 95,
            plots = FALSE,
            signif = "all",
            plotMetU = "ellipse",
            plotMetL = "ellipse",
            plotOrder = "original",
            hclust = FALSE,
            numClust = 2,
            clustMet = "ward.D2",
            clPos = "b",
            clustCol = FALSE,
            clustMan = "",
            clustMat = FALSE, ...) {

            super$initialize(
                package="jYS",
                name="mCOR",
                requiresData=TRUE,
                ...)

            private$..vars <- jmvcore::OptionVariables$new(
                "vars",
                vars,
                required=TRUE,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..group <- jmvcore::OptionVariable$new(
                "group",
                group,
                required=FALSE,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..selgroup <- jmvcore::OptionLevel$new(
                "selgroup",
                selgroup,
                variable="(group)")
            private$..hyp <- jmvcore::OptionList$new(
                "hyp",
                hyp,
                options=list(
                    "corr",
                    "pos",
                    "neg"),
                default="corr")
            private$..method <- jmvcore::OptionList$new(
                "method",
                method,
                options=list(
                    "pearson",
                    "spearman",
                    "kendall"),
                default="pearson")
            private$..adjust <- jmvcore::OptionList$new(
                "adjust",
                adjust,
                options=list(
                    "none",
                    "bonferroni",
                    "holm",
                    "hochberg",
                    "hommel",
                    "BH",
                    "BY"),
                default="none")
            private$..tables <- jmvcore::OptionBool$new(
                "tables",
                tables,
                default=TRUE)
            private$..pval <- jmvcore::OptionBool$new(
                "pval",
                pval,
                default=TRUE)
            private$..flag <- jmvcore::OptionBool$new(
                "flag",
                flag,
                default=FALSE)
            private$..n <- jmvcore::OptionBool$new(
                "n",
                n,
                default=FALSE)
            private$..ci <- jmvcore::OptionBool$new(
                "ci",
                ci,
                default=FALSE)
            private$..ciWidth <- jmvcore::OptionNumber$new(
                "ciWidth",
                ciWidth,
                min=50,
                max=99.9,
                default=95)
            private$..plots <- jmvcore::OptionBool$new(
                "plots",
                plots,
                default=FALSE)
            private$..signif <- jmvcore::OptionList$new(
                "signif",
                signif,
                options=list(
                    "all",
                    "0.1",
                    "0.05",
                    "0.01",
                    "0.001"),
                default="all")
            private$..plotMetU <- jmvcore::OptionList$new(
                "plotMetU",
                plotMetU,
                options=list(
                    "empty",
                    "circle",
                    "square",
                    "ellipse",
                    "number",
                    "shade",
                    "color",
                    "pie"),
                default="ellipse")
            private$..plotMetL <- jmvcore::OptionList$new(
                "plotMetL",
                plotMetL,
                options=list(
                    "empty",
                    "circle",
                    "square",
                    "ellipse",
                    "number",
                    "shade",
                    "color",
                    "pie"),
                default="ellipse")
            private$..plotOrder <- jmvcore::OptionList$new(
                "plotOrder",
                plotOrder,
                options=list(
                    "original",
                    "alphabet",
                    "AOE",
                    "FPC"),
                default="original")
            private$..hclust <- jmvcore::OptionBool$new(
                "hclust",
                hclust,
                default=FALSE)
            private$..numClust <- jmvcore::OptionNumber$new(
                "numClust",
                numClust,
                min=2,
                default=2)
            private$..clustMet <- jmvcore::OptionList$new(
                "clustMet",
                clustMet,
                options=list(
                    "ward.D",
                    "ward.D2",
                    "single",
                    "complete",
                    "average",
                    "mcquitty",
                    "median",
                    "centroid"),
                default="ward.D2")
            private$..clPos <- jmvcore::OptionList$new(
                "clPos",
                clPos,
                options=list(
                    "n",
                    "r",
                    "b"),
                default="b")
            private$..clustCol <- jmvcore::OptionBool$new(
                "clustCol",
                clustCol,
                default=FALSE)
            private$..clustMan <- jmvcore::OptionString$new(
                "clustMan",
                clustMan,
                default="")
            private$..clustMat <- jmvcore::OptionBool$new(
                "clustMat",
                clustMat,
                default=FALSE)

            self$.addOption(private$..vars)
            self$.addOption(private$..group)
            self$.addOption(private$..selgroup)
            self$.addOption(private$..hyp)
            self$.addOption(private$..method)
            self$.addOption(private$..adjust)
            self$.addOption(private$..tables)
            self$.addOption(private$..pval)
            self$.addOption(private$..flag)
            self$.addOption(private$..n)
            self$.addOption(private$..ci)
            self$.addOption(private$..ciWidth)
            self$.addOption(private$..plots)
            self$.addOption(private$..signif)
            self$.addOption(private$..plotMetU)
            self$.addOption(private$..plotMetL)
            self$.addOption(private$..plotOrder)
            self$.addOption(private$..hclust)
            self$.addOption(private$..numClust)
            self$.addOption(private$..clustMet)
            self$.addOption(private$..clPos)
            self$.addOption(private$..clustCol)
            self$.addOption(private$..clustMan)
            self$.addOption(private$..clustMat)
        }),
    active = list(
        vars = function() private$..vars$value,
        group = function() private$..group$value,
        selgroup = function() private$..selgroup$value,
        hyp = function() private$..hyp$value,
        method = function() private$..method$value,
        adjust = function() private$..adjust$value,
        tables = function() private$..tables$value,
        pval = function() private$..pval$value,
        flag = function() private$..flag$value,
        n = function() private$..n$value,
        ci = function() private$..ci$value,
        ciWidth = function() private$..ciWidth$value,
        plots = function() private$..plots$value,
        signif = function() private$..signif$value,
        plotMetU = function() private$..plotMetU$value,
        plotMetL = function() private$..plotMetL$value,
        plotOrder = function() private$..plotOrder$value,
        hclust = function() private$..hclust$value,
        numClust = function() private$..numClust$value,
        clustMet = function() private$..clustMet$value,
        clPos = function() private$..clPos$value,
        clustCol = function() private$..clustCol$value,
        clustMan = function() private$..clustMan$value,
        clustMat = function() private$..clustMat$value),
    private = list(
        ..vars = NA,
        ..group = NA,
        ..selgroup = NA,
        ..hyp = NA,
        ..method = NA,
        ..adjust = NA,
        ..tables = NA,
        ..pval = NA,
        ..flag = NA,
        ..n = NA,
        ..ci = NA,
        ..ciWidth = NA,
        ..plots = NA,
        ..signif = NA,
        ..plotMetU = NA,
        ..plotMetL = NA,
        ..plotOrder = NA,
        ..hclust = NA,
        ..numClust = NA,
        ..clustMet = NA,
        ..clPos = NA,
        ..clustCol = NA,
        ..clustMan = NA,
        ..clustMat = NA)
)

mCORResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "mCORResults",
    inherit = jmvcore::Group,
    active = list(
        text = function() private$.items[["text"]],
        matrix = function() private$.items[["matrix"]],
        treeplot = function() private$.items[["treeplot"]],
        plot = function() private$.items[["plot"]],
        rplots = function() private$.items[["rplots"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Correlation clustering",
                refs="corr")
            self$add(jmvcore::Html$new(
                options=options,
                name="text",
                title="Correlations",
                clearWith=list(
                    "group")))
            self$add(jmvcore::Table$new(
                options=options,
                name="matrix",
                visible="(tables)",
                title="Correlation Matrix",
                rows="(vars)",
                clearWith=list(
                    "ciWidth",
                    "hyp"),
                columns=list(
                    list(
                        `name`=".name[r]", 
                        `title`="", 
                        `type`="text", 
                        `content`="($key)", 
                        `combineBelow`=TRUE, 
                        `visible`="(method==\"pearson\")"),
                    list(
                        `name`=".stat[r]", 
                        `title`="Pearson's r", 
                        `type`="text", 
                        `content`="Pearson's r", 
                        `visible`="(method==\"pearson\")"),
                    list(
                        `name`=".name[rho]", 
                        `title`="", 
                        `type`="text", 
                        `content`="($key)", 
                        `combineBelow`=TRUE, 
                        `visible`="(method==\"spearman\")"),
                    list(
                        `name`=".stat[rho]", 
                        `title`="Spearman's Rho", 
                        `type`="text", 
                        `content`="Spearman's Rho", 
                        `visible`="(method==\"spearman\")"),
                    list(
                        `name`=".name[tau]", 
                        `title`="", 
                        `type`="text", 
                        `content`="($key)", 
                        `combineBelow`=TRUE, 
                        `visible`="(method==\"kendall\")"),
                    list(
                        `name`=".stat[tau]", 
                        `title`="Kendall Tau", 
                        `type`="text", 
                        `content`="Kendall Tau", 
                        `visible`="(method==\"kendall\")"),
                    list(
                        `name`=".name[cil]", 
                        `title`="", 
                        `type`="text", 
                        `content`="($key)", 
                        `combineBelow`=TRUE, 
                        `visible`="(method==\"pearson\" && ci)"),
                    list(
                        `name`=".stat[cil]", 
                        `title`="", 
                        `type`="text", 
                        `content`="CI Lower", 
                        `visible`="(method==\"pearson\" && ci)"),
                    list(
                        `name`=".name[ciu]", 
                        `title`="", 
                        `type`="text", 
                        `content`="($key)", 
                        `combineBelow`=TRUE, 
                        `visible`="(method==\"pearson\" && ci)"),
                    list(
                        `name`=".stat[ciu]", 
                        `title`="", 
                        `type`="text", 
                        `content`="CI Upper", 
                        `visible`="(method==\"pearson\" && ci)"),
                    list(
                        `name`=".name[p]", 
                        `title`="", 
                        `type`="text", 
                        `content`="($key)", 
                        `combineBelow`=TRUE, 
                        `visible`="(pval)"),
                    list(
                        `name`=".stat[p]", 
                        `title`="", 
                        `type`="text", 
                        `content`="p-value", 
                        `visible`="(pval)"),
                    list(
                        `name`=".name[n]", 
                        `title`="", 
                        `type`="text", 
                        `content`="($key)", 
                        `combineBelow`=TRUE, 
                        `visible`="(n)"),
                    list(
                        `name`=".stat[n]", 
                        `title`="", 
                        `type`="text", 
                        `content`="N", 
                        `visible`="(n)"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="treeplot",
                title="Hierarchical clustering tree",
                visible="(hclust)",
                renderFun=".treeplot",
                requiresData=TRUE))
            self$add(jmvcore::Image$new(
                options=options,
                name="plot",
                title="Correlation Matrix",
                visible="(plots)",
                width=500,
                height=500,
                renderFun=".plot",
                requiresData=TRUE))
            self$add(jmvcore::Array$new(
                options=options,
                name="rplots",
                title="Intercluster Matrices",
                visible="(plots && clustMat)",
                template=jmvcore::Image$new(
                    options=options,
                    renderFun=".rplot",
                    requiresData=TRUE)))}))

mCORBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "mCORBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "jYS",
                name = "mCOR",
                version = c(1,0,0),
                options = options,
                results = mCORResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Correlation clustering
#'
#' 
#' @param data .
#' @param vars .
#' @param group .
#' @param selgroup .
#' @param hyp .
#' @param method .
#' @param adjust .
#' @param tables .
#' @param pval .
#' @param flag .
#' @param n .
#' @param ci .
#' @param ciWidth .
#' @param plots \code{TRUE} or \code{FALSE} (default), provide a correlation
#'   matrix plot
#' @param signif .
#' @param plotMetU .
#' @param plotMetL .
#' @param plotOrder .
#' @param hclust .
#' @param numClust .
#' @param clustMet .
#' @param clPos .
#' @param clustCol .
#' @param clustMan .
#' @param clustMat .
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$text} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$matrix} \tab \tab \tab \tab \tab a correlation matrix table \cr
#'   \code{results$treeplot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$rplots} \tab \tab \tab \tab \tab an array of images \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$matrix$asDF}
#'
#' \code{as.data.frame(results$matrix)}
#'
#' @export
mCOR <- function(
    data,
    vars,
    group,
    selgroup,
    hyp = "corr",
    method = "pearson",
    adjust = "none",
    tables = TRUE,
    pval = TRUE,
    flag = FALSE,
    n = FALSE,
    ci = FALSE,
    ciWidth = 95,
    plots = FALSE,
    signif = "all",
    plotMetU = "ellipse",
    plotMetL = "ellipse",
    plotOrder = "original",
    hclust = FALSE,
    numClust = 2,
    clustMet = "ward.D2",
    clPos = "b",
    clustCol = FALSE,
    clustMan = "",
    clustMat = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("mCOR requires jmvcore to be installed (restart may be required)")

    if ( ! missing(vars)) vars <- jmvcore::resolveQuo(jmvcore::enquo(vars))
    if ( ! missing(group)) group <- jmvcore::resolveQuo(jmvcore::enquo(group))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(vars), vars, NULL),
            `if`( ! missing(group), group, NULL))

    for (v in group) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- mCOROptions$new(
        vars = vars,
        group = group,
        selgroup = selgroup,
        hyp = hyp,
        method = method,
        adjust = adjust,
        tables = tables,
        pval = pval,
        flag = flag,
        n = n,
        ci = ci,
        ciWidth = ciWidth,
        plots = plots,
        signif = signif,
        plotMetU = plotMetU,
        plotMetL = plotMetL,
        plotOrder = plotOrder,
        hclust = hclust,
        numClust = numClust,
        clustMet = clustMet,
        clPos = clPos,
        clustCol = clustCol,
        clustMan = clustMan,
        clustMat = clustMat)

    analysis <- mCORClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

